name: Phase 3 & 4 - Download & Index
on:
  workflow_run:
    workflows: ["Phase 2 - Setup"]
    types: [completed]

permissions:
  contents: write

jobs:
  download-and-index:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Download APKs
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: python3 scripts/update_fdroid_repo.py

      - name: Prepare repo directory with APKs
        run: |
          mkdir -p fdroid/repo
          # Copy APKs from the downloaded location to the repo directory for indexing
          find apks/ -name "*.apk" -exec cp {} fdroid/repo/ \; 2>/dev/null || echo "No APKs to copy"

      - name: Inject secure config
        env:
          KEYSTORE_PASS: ${{ secrets.KEYSTORE_PASS }}
          KEY_PASS: ${{ secrets.KEY_PASS }}
        run: |
          sed -i "s|\$KEYPASS|${KEY_PASS}|g" fdroid/config.yml

      - name: Create repo directory
        run: mkdir -p repo

      - name: Run fdroid update
        env:
          FDROID_KEY_STORE_PASS: ${{ secrets.KEYSTORE_PASS }}
          FDROID_KEY_PASS: ${{ secrets.KEY_PASS }}
        run: |
          cd fdroid
          fdroid update --create-metadata --delete-removed

      - name: Copy repository files to deployment directory
        run: |
          # The fdroid update command creates files in fdroid/repo/ based on config.yml
          # Copy these to the repo directory for deployment
          cp -r fdroid/repo/* repo/ 2>/dev/null || echo "No repo files to copy"
          # Also copy any index files that might be in the fdroid directory
          cp fdroid/index-v1.json repo/ 2>/dev/null || echo "No index-v1.json to copy"
          cp fdroid/index-v1.jar repo/ 2>/dev/null || echo "No index-v1.jar to copy"
          cp fdroid/index.xml repo/ 2>/dev/null || echo "No index.xml to copy"

      - name: Copy icons and metadata
        run: |
          cp -r fdroid/metadata/icons repo/ 2>/dev/null || echo "No icons to copy"
          cp -r fdroid/metadata/*.yml repo/ 2>/dev/null || echo "No metadata files to copy"

      - name: Upload F-Droid repository
        uses: actions/upload-artifact@v4
        with:
          name: fdroid-repo
          path: repo
          retention-days: 1
          if-no-files-found: error
          compression-level: 5